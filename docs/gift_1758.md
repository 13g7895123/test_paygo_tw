# 手動派獎功能權限調整清單

## 問題分析
目前 send_gift 手動派獎功能僅限管理員使用，需要下放給每個服主（分享用戶）都可以使用，並確保只能操作自己有權限的伺服器。

## 當前權限架構
1. **管理員 (adminid)**: 可以看到所有伺服器
2. **分享用戶/服主 (shareid)**: 只能看到 shareuser_server2 表中授權的伺服器
3. **權限檢查函數**:
   - `check_login()`: 僅檢查管理員
   - `check_login_share()`: 檢查管理員或分享用戶

## 需要調整的項目

### 1. send_gift.php (主頁面)
**當前問題**:
- 第3行 `// check_login();` 被註解掉，沒有權限檢查

**調整方案**:
```php
// 第3行改為：
check_login_share(); // 允許管理員和分享用戶訪問
```

### 2. gift_api.php (API端點)
**當前狀態**:
- handle_get_servers() 已正確實作權限分離（第144-165行）
- 管理員看到所有伺服器，分享用戶只看到授權伺服器

**需要檢查**:
- 確保所有派獎相關的操作（send_gift, get_server_items等）都有權限驗證
- 在執行派獎前，檢查用戶是否有該伺服器的權限

**建議新增權限檢查函數**:
```php
function check_server_permission($pdo, $server_id, $user_id = null, $is_admin = false) {
    // 管理員有所有權限
    if ($is_admin) {
        return true;
    }

    // 分享用戶檢查 shareuser_server2 表
    if ($user_id) {
        $query = $pdo->prepare("
            SELECT COUNT(*) as count
            FROM servers s
            INNER JOIN shareuser_server2 sus ON s.id = sus.serverid
            WHERE s.auton = :server_id AND sus.uid = :user_id
        ");
        $query->bindParam(':server_id', $server_id);
        $query->bindParam(':user_id', $user_id);
        $query->execute();
        $result = $query->fetch(PDO::FETCH_ASSOC);
        return $result['count'] > 0;
    }

    return false;
}
```

### 3. handle_send_gift() 函數
**需要新增權限檢查**:
```php
// 在執行派獎前，檢查權限
$server_id = $_POST['server_id'];
$is_admin = !empty($_SESSION["adminid"]);
$user_id = $_SESSION["shareid"] ?? null;

if (!check_server_permission($pdo, $server_id, $user_id, $is_admin)) {
    api_error('您沒有此伺服器的操作權限', 403);
}
```

### 4. handle_get_server_items() 函數
**需要新增權限檢查**:
- 確保用戶只能查看和管理自己有權限的伺服器物品

### 5. handle_add_server_item() / handle_delete_server_item() 函數
**需要新增權限檢查**:
- 確保用戶只能為自己有權限的伺服器新增/刪除物品

### 6. 資料庫追蹤
**新增派獎記錄表** (如果還沒有):
```sql
CREATE TABLE IF NOT EXISTS gift_send_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    server_id INT NOT NULL,
    operator_id VARCHAR(50) NOT NULL,
    operator_type ENUM('admin', 'share') NOT NULL,
    game_account VARCHAR(100) NOT NULL,
    items TEXT NOT NULL,
    send_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    status ENUM('success', 'failed') NOT NULL,
    error_message TEXT,
    INDEX idx_server_operator (server_id, operator_id)
);
```

### 7. 頁面顯示調整
**myadm/send_gift.php**:
- 確保下拉選單只顯示用戶有權限的伺服器
- 顯示操作者身份（管理員/服主）

### 8. 安全性考量
1. **SQL注入防護**: 確保所有查詢使用參數化查詢
2. **會話劫持防護**: 確保會話安全
3. **操作日誌**: 記錄所有派獎操作
4. **權限驗證**: 每個API操作都需要驗證權限

## 實施步驟
1. ✅ 修復 send_gift.php 的登入檢查
2. ✅ 新增權限檢查函數
3. ✅ 更新所有 API 端點加入權限驗證
4. ✅ 測試管理員權限
5. ✅ 測試分享用戶權限
6. ✅ 建立操作日誌
7. ✅ 部署到測試環境驗證

## 測試案例
1. **管理員測試**:
   - 登入管理員帳號
   - 應能看到所有伺服器
   - 應能為任何伺服器派獎

2. **分享用戶測試**:
   - 登入分享用戶帳號
   - 只能看到被授權的伺服器
   - 只能為授權伺服器派獎
   - 嘗試操作未授權伺服器應被拒絕

3. **未登入測試**:
   - 直接訪問 send_gift.php 應重導向到登入頁
   - 直接調用 API 應返回未授權錯誤

## 相關檔案清單
- `/myadm/send_gift.php` - 主頁面
- `/myadm/api/gift_api.php` - API處理
- `/myadm/include.php` - 權限檢查函數
- `/myadm/index.php` - 伺服器管理（參考權限實作）
- `shareuser_server2` 表 - 分享用戶權限對應表