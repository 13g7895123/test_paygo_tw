# ANT 代收代付服務 API 功能規劃

## API 概述

基於ANT代收代付服務的API文檔分析，這是一個專門處理銀行轉帳的第三方支付服務。與其他支付服務不同，ANT需要收集使用者的銀行代號與帳號進行轉帳操作。

## 核心功能項目

### 1. 支付請求創建 (Payment Creation)

**功能說明**: 創建ANT支付請求，初始化轉帳流程

**實作重點**:
- 集成使用者銀行代號和帳號
- 生成ANT專用的支付訂單
- 驗證銀行資訊格式

**預期API端點**: `/api/ant/payment/create`

**主要參數**:
- `merchant_id`: 商店代號
- `order_id`: 訂單編號
- `amount`: 支付金額
- `user_bank_code`: 使用者銀行代號 (3位數字)
- `user_bank_account`: 使用者銀行帳號
- `callback_url`: 回調通知網址
- `return_url`: 支付完成返回網址

### 2. 銀行帳戶驗證 (Bank Account Validation)

**功能說明**: 驗證使用者提供的銀行代號和帳號是否有效

**實作重點**:
- 即時驗證銀行代號格式
- 檢查帳號有效性
- 提供驗證結果回饋

**預期API端點**: `/api/ant/account/validate`

**主要參數**:
- `bank_code`: 銀行代號
- `account_number`: 銀行帳號

### 3. 支付狀態查詢 (Payment Status Query)

**功能說明**: 查詢ANT支付交易的當前狀態

**實作重點**:
- 定期查詢支付進度
- 處理各種支付狀態
- 同步狀態到本地資料庫

**預期API端點**: `/api/ant/payment/status`

**主要參數**:
- `order_id`: 訂單編號
- `merchant_id`: 商店代號

### 4. 支付結果通知處理 (Payment Notification Handler)

**功能說明**: 處理ANT服務的支付結果回調通知

**實作重點**:
- 驗證通知簽名
- 更新訂單狀態
- 觸發後續流程

**預期API端點**: `/api/ant/notification/receive`

**處理狀態**:
- 支付成功
- 支付失敗
- 支付超時
- 銀行帳戶錯誤

### 5. 退款請求 (Refund Request)

**功能說明**: 處理ANT支付的退款申請

**實作重點**:
- 驗證退款條件
- 執行退款流程
- 記錄退款狀態

**預期API端點**: `/api/ant/refund/create`

**主要參數**:
- `original_order_id`: 原始訂單編號
- `refund_amount`: 退款金額
- `refund_reason`: 退款原因

## 系統整合項目

### 1. 資料庫整合

**servers_log 表擴充**:
- 已完成: `user_bank_code` 和 `user_bank_account` 欄位
- 狀態: 可NULL，符合ANT專用需求

**bank_funds 表設定**:
- ANT商店設定已整合
- merchant_id 對應 ANT 商店代號
- verify_key 對應 ANT 檢查碼

### 2. 前端整合

**index.php 修改**:
- ✅ 已完成：ANT專用欄位區塊
- ✅ 已完成：動態顯示控制
- ✅ 已完成：表單驗證邏輯

**ant_next.php 實作**:
- ✅ 基礎架構已建立
- 🔄 API整合待完成

### 3. 支付流程整合

**標準流程**:
1. 使用者選擇ANT銀行轉帳
2. 輸入銀行代號和帳號
3. 前端驗證格式
4. 提交到 index.php
5. 資料寫入 servers_log
6. 重定向到 ant_next.php
7. 調用ANT API創建支付
8. 處理支付結果
9. 更新訂單狀態

## 實作優先順序

### Phase 1: 核心支付功能
1. **支付請求創建** (高優先級)
   - 修改 ant_next.php
   - 實作支付請求API調用
   - 處理API回應

2. **支付狀態查詢** (高優先級)
   - 實作狀態查詢邏輯
   - 定期檢查支付進度
   - 更新本地狀態

### Phase 2: 增強功能
3. **銀行帳戶驗證** (中優先級)
   - 前端即時驗證
   - 提升使用者體驗

4. **支付結果通知** (中優先級)
   - 建立回調端點
   - 處理異步通知

### Phase 3: 完整功能
5. **退款功能** (低優先級)
   - 管理端退款操作
   - 退款狀態追蹤

## 安全考量

### 1. 資料保護
- 銀行帳號資訊加密存儲
- 傳輸過程HTTPS保護
- 敏感資料日誌過濾

### 2. API安全
- 簽名驗證機制
- 請求頻率限制
- IP白名單控制

### 3. 使用者資料
- 銀行代號格式驗證
- 帳號格式檢查
- 防止資料洩露

## 監控與日誌

### 1. 交易監控
- 支付成功率統計
- 失敗原因分析
- 處理時間監控

### 2. 錯誤處理
- API錯誤記錄
- 銀行帳戶錯誤追蹤
- 系統異常告警

### 3. 業務數據
- 交易金額統計
- 用戶行為分析
- 支付方式偏好

## API 實作檢查清單

- [ ] 支付請求創建API
- [ ] 銀行帳戶驗證API
- [ ] 支付狀態查詢API
- [ ] 支付結果通知處理
- [ ] 退款請求API
- [ ] 錯誤處理機制
- [ ] 安全驗證機制
- [ ] 日誌記錄系統
- [ ] 監控告警機制
- [ ] 測試環境配置
- [ ] 正式環境部署
- [ ] 文檔完善

## 備註

此規劃基於ANT代收代付服務的特性和現有系統架構。實際API實作時需要：

1. 獲取完整的ANT API文檔
2. 確認具體的API端點和參數格式
3. 測試API的各種回應情況
4. 處理不同的錯誤狀態
5. 優化使用者體驗流程

當獲得完整API文檔後，此規劃將根據實際API規格進行調整和細化。